//@version=5
indicator("Risk Management", overlay=true, precision=1)

// ═══════════════════════════════════════════════════════════════════════════════
// ACCOUNT SETTINGS
// ═══════════════════════════════════════════════════════════════════════════════

account_balance = input.int(5000, "Account Initial Balance", group="Account Settings")
max_risk = input.float(1, "Maximum Risk Percentage", group="Account Settings")
loss_count = input.int(4, "Number of Losses Before Risk Adjustment", group="Account Settings")
multiplier = input.float(0.25, "Risk Adjustment Multiplier", group="Account Settings")

// ═══════════════════════════════════════════════════════════════════════════════
// LOT SIZE SETTINGS
// ═══════════════════════════════════════════════════════════════════════════════

risk_percentage = input.float(0.5, title="Risk Percentage (%)", group="Lot Size Calculation")
min_stop_loss_pips = input(10, title="Min Stop Loss (pips)", group="Lot Size Calculation")
max_stop_loss_pips = input(10, title="Max Stop Loss (pips)", group="Lot Size Calculation")

// ═══════════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Calculate percentage of an amount
get_percentage(percentage, amount) => 
    amount / 100 * percentage

// Calculate balance after consecutive losses (Drawdown)
calculate_dd_balance(percentage_amount, balance) => 
    balance - percentage_amount * loss_count

// Calculate balance after consecutive wins (Drawup)
calculate_du_balance(percentage_amount, balance) => 
    balance + percentage_amount * loss_count

// ═══════════════════════════════════════════════════════════════════════════════
// TABLE SETUP
// ═══════════════════════════════════════════════════════════════════════════════

var info_table = table.new(position=position.top_right, columns=3, rows=11, border_color=color.black, frame_width=200)

// ═══════════════════════════════════════════════════════════════════════════════
// DD (DRAWDOWN) MANAGEMENT
// Shows balance and reduced risk % after consecutive losses
// Risk decreases by multiplier for each loss tier
// ═══════════════════════════════════════════════════════════════════════════════

table.cell(info_table, 0, 1, 'DD Management', text_color=color.black, text_size=size.small)
table.cell(info_table, 0, 2, 'Balance: ' + str.tostring(account_balance) + ' - Risk: ' + str.tostring(max_risk) + '%', text_color=color.black, text_size=size.small)

// Calculate progressive DD balances
var dd_balance_tier2 = calculate_dd_balance(get_percentage(max_risk, account_balance), account_balance)
var dd_balance_tier3 = calculate_dd_balance(get_percentage(max_risk - multiplier, dd_balance_tier2), dd_balance_tier2)
var dd_balance_tier4 = calculate_dd_balance(get_percentage(max_risk - (multiplier * 2), dd_balance_tier3), dd_balance_tier3)

table.cell(info_table, 0, 3, 'Balance: ' + str.tostring(dd_balance_tier2) + ' - Risk: ' + str.tostring(max_risk - multiplier) + '%', text_color=color.black, text_size=size.small)
table.cell(info_table, 0, 4, 'Balance: ' + str.tostring(dd_balance_tier3) + ' - Risk: ' + str.tostring(max_risk - (multiplier * 2)) + '%', text_color=color.black, text_size=size.small)
table.cell(info_table, 0, 5, 'Balance: ' + str.tostring(dd_balance_tier4) + ' - Risk: ' + str.tostring(max_risk - (multiplier * 3)) + '%', text_color=color.black, text_size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// DU (DRAWUP) MANAGEMENT
// Shows balance and increased risk % after consecutive wins
// Risk increases by multiplier for each win tier
// ═══════════════════════════════════════════════════════════════════════════════

table.cell(info_table, 1, 1, 'DU Management', text_color=color.black, text_size=size.small)
table.cell(info_table, 1, 2, 'Balance: ' + str.tostring(account_balance) + ' - Risk: ' + str.tostring(max_risk) + '%', text_color=color.black, text_size=size.small)

// Calculate progressive DU balances
var du_balance_tier2 = calculate_du_balance(get_percentage(max_risk, account_balance), account_balance)
var du_balance_tier3 = calculate_du_balance(get_percentage(max_risk + multiplier, du_balance_tier2), du_balance_tier2)
var du_balance_tier4 = calculate_du_balance(get_percentage(max_risk + (multiplier * 2), du_balance_tier3), du_balance_tier3)

table.cell(info_table, 1, 3, 'Balance: ' + str.tostring(du_balance_tier2) + ' - Risk: ' + str.tostring(max_risk + multiplier) + '%', text_color=color.black, text_size=size.small)
table.cell(info_table, 1, 4, 'Balance: ' + str.tostring(du_balance_tier3) + ' - Risk: ' + str.tostring(max_risk + (multiplier * 2)) + '%', text_color=color.black, text_size=size.small)
table.cell(info_table, 1, 5, 'Balance: ' + str.tostring(du_balance_tier4) + ' - Risk: ' + str.tostring(max_risk + (multiplier * 3)) + '%', text_color=color.black, text_size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// LOT SIZE CALCULATION
// Calculates position size for different stop loss distances
// Formula: (Risk Amount) / (Pip Value * Stop Loss Pips)
// ═══════════════════════════════════════════════════════════════════════════════

risk_amount = (risk_percentage / 100) * account_balance
pip_value = syminfo.mintick * syminfo.pointvalue
row_counter = 1

table.cell(info_table, 2, 1, 'Lot Size', text_color=color.black, text_size=size.small)

// Loop through stop loss range and calculate lot size for each
for stop_loss_pips = min_stop_loss_pips to max_stop_loss_pips by 1
    row_counter := row_counter + 1
    
    // Calculate position size
    position_size = risk_amount / (pip_value * stop_loss_pips)
    
    // Convert to micro lots
    micro_lots = position_size / 1000000
    
    // Display in table
    table.cell(info_table, 2, row_counter, str.tostring(micro_lots, "#.##") + " x " + str.tostring(stop_loss_pips) + " Pips SL", text_color=color.black, text_size=size.small)
